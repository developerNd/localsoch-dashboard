<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Seller Login</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>Test Seller Login and Vendor Lookup</h1>
    
    <div>
        <h3>Login as Seller</h3>
        <input type="text" id="username" placeholder="Username" value="citybakery">
        <input type="password" id="password" placeholder="Password" value="password123">
        <button onclick="login()">Login</button>
    </div>
    
    <div>
        <h3>Test Vendor Lookup</h3>
        <input type="text" id="userId" placeholder="User ID" value="4">
        <button onclick="testVendorLookup()">Test Vendor Lookup</button>
    </div>
    
    <div>
        <h3>Test Products for Vendor</h3>
        <input type="text" id="vendorId" placeholder="Vendor ID" value="26">
        <button onclick="testProducts()">Test Products</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let authToken = null;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logs.appendChild(div);
        }
        
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log(`Attempting login for user: ${username}`);
            
            try {
                const response = await fetch('http://localhost:1337/api/auth/local', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        identifier: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.jwt;
                    log(`Login successful! Token: ${authToken.substring(0, 20)}...`, 'success');
                    log(`User data: ${JSON.stringify(data.user, null, 2)}`, 'success');
                    
                    // Test vendor lookup immediately after login
                    await testVendorLookupForUser(data.user.id);
                } else {
                    log(`Login failed: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        }
        
        async function testVendorLookup() {
            const userId = document.getElementById('userId').value;
            await testVendorLookupForUser(userId);
        }
        
        async function testVendorLookupForUser(userId) {
            log(`Testing vendor lookup for user ID: ${userId}`);
            
            try {
                // First, get all vendors to see the data structure
                const allVendorsResponse = await fetch('http://localhost:1337/api/vendors?populate=user', {
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (allVendorsResponse.ok) {
                    const allVendorsData = await allVendorsResponse.json();
                    log(`All vendors: ${JSON.stringify(allVendorsData, null, 2)}`);
                    
                    // Look for vendor with matching user
                    const matchingVendor = allVendorsData.data.find(vendor => 
                        vendor.user && vendor.user.id == userId
                    );
                    
                    if (matchingVendor) {
                        log(`Found matching vendor: ${matchingVendor.name} (ID: ${matchingVendor.id})`, 'success');
                        document.getElementById('vendorId').value = matchingVendor.id;
                    } else {
                        log(`No vendor found for user ${userId}`, 'error');
                    }
                } else {
                    const errorText = await allVendorsResponse.text();
                    log(`Error fetching vendors: ${errorText}`, 'error');
                }
                
                // Also try the filtered API
                const filteredResponse = await fetch(`http://localhost:1337/api/vendors?filters[user][id][$eq]=${userId}&populate=user`, {
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (filteredResponse.ok) {
                    const filteredData = await filteredResponse.json();
                    log(`Filtered vendors: ${JSON.stringify(filteredData, null, 2)}`);
                } else {
                    const errorText = await filteredResponse.text();
                    log(`Error with filtered API: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`Vendor lookup error: ${error.message}`, 'error');
            }
        }
        
        async function testProducts() {
            const vendorId = document.getElementById('vendorId').value;
            log(`Testing products for vendor ID: ${vendorId}`);
            
            try {
                const response = await fetch(`http://localhost:1337/api/products?filters[vendor][id][$eq]=${vendorId}&populate=*`, {
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Products for vendor ${vendorId}: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`Error fetching products: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Products error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html> 